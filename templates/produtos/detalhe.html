{% extends 'base.html' %}
{% load static %}

{% block title %}{{ produto.nome }} - Farmácia QUEOPS{% endblock %}

{% block content %}
<div class="container" style="margin-top: 2rem;">
    <!-- Breadcrumb -->
    <nav style="margin-bottom: 2rem; color: var(--cinza-escuro);">
        <a href="{% url 'core:home' %}" style="color: var(--verde-principal);">Home</a> / 
        <a href="{% url 'produtos:lista' %}" style="color: var(--verde-principal);">Produtos</a> / 
        <a href="?categoria={{ produto.categoria.slug }}" style="color: var(--verde-principal);">{{ produto.categoria.nome }}</a> / 
        <span>{{ produto.nome }}</span>
    </nav>

    <!-- Detalhes do Produto -->
    <div class="produto-detalhe">
        <!-- Imagem -->
        <div>
            {% if produto.imagem %}
                <img src="{{ produto.imagem_detalhe.url }}" alt="{{ produto.nome }}" loading="eager">
            {% else %}
                <img src="{% static 'img/produto-sem-imagem.png' %}" alt="{{ produto.nome }}" loading="eager">
            {% endif %}
        </div>

        <!-- Informações -->
        <div>
            <h1 style="color: var(--verde-principal); margin-bottom: 1rem;">
                {{ produto.nome }}
            </h1>

            <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <span style="background-color: var(--surface-strong); padding: 0.5rem 1rem; border-radius: 5px; display: inline-block; color: var(--neutral-700); font-size: 0.9rem;">
                    {{ produto.categoria.nome }}
                </span>
                {% if produto.destaque %}
                    <span class="badge-destaque">DESTAQUE</span>
                {% endif %}
                {% if produto.tem_promocao %}
                    <span class="badge-promocao">PROMOÇÃO</span>
                {% endif %}
            </div>

            <div style="background-color: var(--branco); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <p style="font-size: 1.1rem; line-height: 1.8; color: var(--cinza-escuro);">
                    {{ produto.descricao }}
                </p>
            </div>

            <!-- Preço -->
            <div style="background-color: var(--cinza-claro); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                {% if produto.tem_promocao %}
                    <div style="margin-bottom: 0.5rem;">
                        <span class="preco-antigo" style="font-size: 1.2rem;">De: R$ {{ produto.preco }}</span>
                    </div>
                    <div class="preco preco-promocional" style="font-size: 2rem;">
                        Por: R$ {{ produto.preco_promocional }}
                    </div>
                    <p style="color: var(--verde-principal); font-weight: bold; margin-top: 0.5rem;">
                        Economize: R$ {{ produto.preco|floatformat:2|add:produto.preco_promocional|floatformat:2 }}
                    </p>
                {% else %}
                    <div class="preco" style="font-size: 2rem;">
                        R$ {{ produto.preco }}
                    </div>
                {% endif %}
            </div>

            <!-- Estoque -->
            <div style="margin-bottom: 1.5rem;">
                {% if produto.estoque > 0 %}
                    {% if produto.estoque < 10 %}
                        <p class="estoque-info estoque-baixo" style="font-size: 1rem; padding: 0.75rem; background-color: rgba(192, 57, 43, 0.08); border-left: 3px solid var(--accent-danger); border-radius: 6px;">
                            <strong>Estoque limitado:</strong> Apenas {{ produto.estoque }} unidades disponíveis
                        </p>
                    {% else %}
                        <p class="estoque-info" style="font-size: 1rem; padding: 0.75rem; background-color: var(--brand-050); border-left: 3px solid var(--brand-500); border-radius: 6px;">
                            <strong>Em estoque:</strong> {{ produto.estoque }} unidades disponíveis
                        </p>
                    {% endif %}
                {% else %}
                    <p class="estoque-info estoque-baixo" style="font-size: 1rem; padding: 0.75rem; background-color: rgba(192, 57, 43, 0.08); border-left: 3px solid var(--accent-danger); border-radius: 6px;">
                        <strong>Produto indisponível</strong>
                    </p>
                {% endif %}
            </div>

            <!-- Botão Adicionar ao Carrinho -->
            {% if produto.estoque > 0 %}
                <form action="{% url 'pedidos:adicionar_carrinho' produto.id %}" method="post" style="margin-bottom: 1rem;">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                        <label for="quantidade" style="font-weight: bold;">Quantidade:</label>
                        <input 
                            type="number" 
                            name="quantidade" 
                            id="quantidade" 
                            value="1" 
                            min="1" 
                            max="{{ produto.estoque }}"
                            style="width: 100px; padding: 0.5rem; border: 1px solid var(--cinza-medio); border-radius: 5px;"
                        >
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" style="font-size: 1.1rem; padding: 1rem;">
                        Adicionar ao Carrinho
                    </button>
                </form>
            {% else %}
                <button class="btn btn-secondary btn-block" disabled style="font-size: 1.2rem; padding: 1rem;">
                    Produto Indisponível
                </button>
            {% endif %}

            {% if user.is_authenticated %}
                {% if em_lista_desejos %}
                    <form action="{% url 'usuarios:remover_desejo' produto.id %}" method="post" style="margin-bottom: 1rem;">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <button type="submit" class="btn btn-secondary btn-block">
                            Remover da Lista de Desejos
                        </button>
                    </form>
                {% else %}
                    <form action="{% url 'usuarios:adicionar_desejo' produto.id %}" method="post" style="margin-bottom: 1rem;">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <button type="submit" class="btn btn-secondary btn-block">
                            Adicionar à Lista de Desejos
                        </button>
                    </form>
                {% endif %}
            {% else %}
                <a href="{% url 'usuarios:login' %}?next={{ request.get_full_path|urlencode }}" class="btn btn-secondary btn-block" style="margin-bottom: 1rem;">
                    Faça login para adicionar aos favoritos
                </a>
            {% endif %}

            <a href="{% url 'produtos:lista' %}" class="btn btn-secondary btn-block" style="margin-top: 0.5rem;">
                ← Voltar para Produtos
            </a>
        </div>
    </div>

    <!-- Avaliações do Produto -->
    <section style="margin-top: 4rem; margin-bottom: 3rem;">
        <h2 style="color: var(--verde-principal); margin-bottom: 1.5rem;">
            Avaliações dos Clientes
        </h2>

        <!-- Média de Avaliações -->
        {% if produto.total_avaliacoes > 0 %}
        <div style="background-color: var(--cinza-claro); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; display: flex; align-items: center; gap: 2rem;">
            <div style="text-align: center;">
                <div style="font-size: 3rem; font-weight: bold; color: var(--verde-principal);">
                    {{ produto.media_avaliacoes|floatformat:1 }}
                </div>
                <div style="color: var(--amarelo); font-size: 1.5rem;">
                    {% for i in "12345" %}
                        {% if forloop.counter <= produto.media_avaliacoes %}
                            ★
                        {% else %}
                            ☆
                        {% endif %}
                    {% endfor %}
                </div>
                <div style="color: var(--cinza-escuro); margin-top: 0.5rem;">
                    {{ produto.total_avaliacoes }} avaliação{{ produto.total_avaliacoes|pluralize:"ões" }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Formulário de Avaliação -->
        {% if user.is_authenticated %}
            {% if not ja_avaliou %}
            <div style="background-color: var(--branco); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid var(--cinza-medio);">
                <h3 style="color: var(--verde-principal); margin-bottom: 1rem;">Avaliar este produto</h3>
                <form action="{% url 'produtos:adicionar_avaliacao' produto.id %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="rating" style="font-weight: bold; margin-bottom: 0.5rem; display: block;">Nota:</label>
                        <div style="display: flex; gap: 0.5rem; font-size: 2rem; color: var(--amarelo);">
                            {% for i in "12345" %}
                            <label style="cursor: pointer;">
                                <input type="radio" name="rating" value="{{ forloop.counter }}" required style="display: none;" class="rating-input">
                                <span class="rating-star">☆</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="comentario" style="font-weight: bold; margin-bottom: 0.5rem; display: block;">Comentário:</label>
                        <textarea 
                            name="comentario" 
                            id="comentario" 
                            rows="4" 
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--cinza-medio); border-radius: 5px; font-family: inherit;"
                            placeholder="Compartilhe sua experiência com este produto..."
                        ></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        Enviar Avaliação
                    </button>
                </form>
            </div>
            {% else %}
            <div style="background-color: var(--brand-050); padding: 1rem; border-radius: 8px; margin-bottom: 2rem; border-left: 3px solid var(--brand-500);">
                <p style="color: var(--cinza-escuro);">Você já avaliou este produto. Obrigado pelo seu feedback!</p>
            </div>
            {% endif %}
        {% else %}
        <div style="background-color: var(--cinza-claro); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; text-align: center;">
            <p style="margin-bottom: 1rem;">Faça login para avaliar este produto</p>
            <a href="{% url 'usuarios:login' %}?next={{ request.get_full_path|urlencode }}" class="btn btn-primary">
                Fazer Login
            </a>
        </div>
        {% endif %}

        <!-- Lista de Avaliações -->
        {% if avaliacoes %}
        <div>
            <h3 style="color: var(--verde-principal); margin-bottom: 1.5rem;">
                Todas as Avaliações ({{ avaliacoes|length }})
            </h3>
            {% for avaliacao in avaliacoes %}
            <div style="background-color: var(--branco); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--cinza-medio);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                    <div>
                        <div style="font-weight: bold; color: var(--verde-principal);">
                            {{ avaliacao.usuario.first_name|default:avaliacao.usuario.username }}
                        </div>
                        <div style="color: var(--amarelo); font-size: 1.2rem;">
                            {% for i in "12345" %}
                                {% if forloop.counter <= avaliacao.rating %}
                                    ★
                                {% else %}
                                    ☆
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <div style="color: var(--cinza-escuro); font-size: 0.9rem;">
                        {{ avaliacao.criado_em|date:"d/m/Y" }}
                    </div>
                </div>
                {% if avaliacao.comentario %}
                <p style="color: var(--cinza-escuro); line-height: 1.6;">
                    {{ avaliacao.comentario }}
                </p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% elif produto.total_avaliacoes == 0 %}
        <div style="background-color: var(--cinza-claro); padding: 2rem; border-radius: 8px; text-align: center; color: var(--cinza-escuro);">
            <p style="font-size: 1.1rem;">Este produto ainda não possui avaliações.</p>
            {% if user.is_authenticated %}
            <p style="margin-top: 0.5rem;">Seja o primeiro a avaliar!</p>
            {% endif %}
        </div>
        {% endif %}
    </section>

    <!-- Produtos Relacionados -->
    {% if produtos_relacionados %}
    <section style="margin-top: 4rem; margin-bottom: 3rem;">
        <h2 style="color: var(--verde-principal); margin-bottom: 1.5rem; text-align: center;">
            Produtos Relacionados
        </h2>
        <div class="produtos-grid">
            {% for prod in produtos_relacionados %}
            <div class="card">
                {% if prod.imagem %}
                    <img src="{{ prod.thumbnail.url }}" alt="{{ prod.nome }}" class="card-img" loading="lazy">
                {% else %}
                    <img src="{% static 'img/produto-sem-imagem.png' %}" alt="{{ prod.nome }}" class="card-img" loading="lazy">
                {% endif %}
                <div class="card-body">
                    {% if prod.tem_promocao %}
                        <span class="badge-promocao">PROMOÇÃO</span>
                    {% endif %}
                    <h3 class="card-title">{{ prod.nome }}</h3>
                    <p class="card-text">{{ prod.descricao|truncatewords:10 }}</p>
                    
                    {% if prod.tem_promocao %}
                        <div>
                            <span class="preco-antigo">R$ {{ prod.preco }}</span>
                            <div class="preco preco-promocional">R$ {{ prod.preco_promocional }}</div>
                        </div>
                    {% else %}
                        <div class="preco">R$ {{ prod.preco }}</div>
                    {% endif %}
                    
                    <a href="{% url 'produtos:detalhe' prod.slug %}" class="btn btn-primary btn-block">
                        Ver Detalhes
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}
</div>

{% block extra_js %}
<script>
// Sistema de avaliação com estrelas interativas
document.addEventListener('DOMContentLoaded', function() {
    const ratingInputs = document.querySelectorAll('.rating-input');
    const ratingStars = document.querySelectorAll('.rating-star');
    
    // Hover effect
    ratingStars.forEach((star, index) => {
        star.addEventListener('mouseenter', function() {
            highlightStars(index);
        });
        
        star.addEventListener('click', function() {
            ratingInputs[index].checked = true;
            highlightStars(index);
        });
    });
    
    // Reset on mouse leave
    const ratingContainer = document.querySelector('.rating-star')?.parentElement?.parentElement;
    if (ratingContainer) {
        ratingContainer.addEventListener('mouseleave', function() {
            const checkedInput = document.querySelector('.rating-input:checked');
            if (checkedInput) {
                const checkedIndex = Array.from(ratingInputs).indexOf(checkedInput);
                highlightStars(checkedIndex);
            } else {
                resetStars();
            }
        });
    }
    
    function highlightStars(index) {
        ratingStars.forEach((star, i) => {
            star.textContent = i <= index ? '★' : '☆';
        });
    }
    
    function resetStars() {
        ratingStars.forEach(star => {
            star.textContent = '☆';
        });
    }
});
</script>
{% endblock %}
